// ==UserScript==
// @name               Easy Compare
// @description        Compare images
// @version            0.9.0
// @author             Secant (TYT@NexusHD)
// @license            GPL-3.0-or-later
// @supportURL         zzwu@zju.edu.cn
// @contributionURL    https://i.loli.net/2020/02/28/JPGgHc3UMwXedhv.jpg
// @contributionAmount 10
// @include            *
// @require            https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js
// @require            https://bundle.run/pixelmatch@5.1.0
// @resource           PixelMatchCore https://bundle.run/pixelmatch@5.1.0
// @namespace          https://greasyfork.org/users/152136
// @icon               data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23008000'%3E%3Cpath id='ld' d='M20 6H10c-2.21 0-4 1.79-4 4v28c0 2.21 1.79 4 4 4h10v4h4V2h-4v4zm0 30H10l10-12v12zM38 6H28v4h10v26L28 24v18h10c2.21 0 4-1.79 4-4V10c0-2.21-1.79-4-4-4z'/%3E%3C/svg%3E
// @grant              GM_xmlhttpRequest
// @grant              GM_download
// @grant              GM_getValue
// @grant              GM_setValue
// @grant              GM_getResourceText
// @grant              unsafewindow
// @connect            hdbits.org
// @connect            awesome-hd.me
// @connect            ptpimg.me
// @connect            imgbox.com
// @connect            malzo.com
// @connect            imagebam.com
// @connect            pixhost.to
// @connect            loli.net
// @connect            funkyimg.com
// @connect            ilikeshots.club
// @connect            z4a.net
// @connect            picgd.com
// @connect            tu.totheglory.im
// @connect            tpimg.ccache.org
// @connect            pterclub.com
// @connect            catbox.moe
// @connect            *
// ==/UserScript==
// jshint ignore: start
(async function(e,t,a,o){"use strict";function n(e,t=5,a=5.5){const o=a*Math.PI-128/t,n=-1/4194304*o,r=3/32768*o,s=1/t;return Math.round(127.9999*Math.sin(n*e**3+r*e**2+s*e-Math.PI/2)+127.5)||0}async function r(e,[t,a,o]){return new Promise(n=>{e.onmessage=(e=>{n(e.data.result)}),e.postMessage({R:t.buffer,G:a.buffer,B:o.buffer},[t.buffer,a.buffer,o.buffer])})}function s(e){e.apply(self);const t=Uint8ClampedArray;self.onmessage=(({data:{key:e,img1:a,img2:o,width:n,height:r,init:s}})=>{a=new t(a),o=new t(o);const i=new t(a);try{self.pixelmatch(a,o,i,n,r,s),self.postMessage({diff:i.buffer,width:n,height:r,key:e},[i.buffer])}catch(t){console.warn(t),self.postMessage({diff:null,key:e})}})}function i(e){const t=Uint8ClampedArray;self.onmessage=(({data:{key:a,R:o,G:n,B:r,img:s,width:i,height:c}})=>{if(o&&n&&r)self.RGB=[new t(o),new t(n),new t(r)],self.postMessage({result:!0});else{s=new t(s);const o=new t(s);try{e.apply(self,[s,o,i,c,self.RGB]),self.postMessage({filter:o.buffer,width:i,height:c,key:a},[o.buffer])}catch(e){console.warn(e),self.postMessage({filter:null,key:a})}}})}function c(e,t){return`(${e.toString()})(${t})`}function l(t){return e(t,document.implementation.createHTMLDocument("virtual"))}function p(t="red"){const a=e("<figure/>").css({width:"fit-content",position:"fixed",top:"50%",left:"50%",margin:"0","vertical-align":"middle"}),o=e("<canvas/>").css({display:"none",transform:"translate(-50%, -50%)",opacity:"1",outline:"3px solid "+t,"outline-offset":"2px"});return a.append(o),o[0]}function m(e,t,a="16px sans serif",o="rgba(255,255,255,255)"){const n=e.getContext("2d");n.font=a,e.width=n.measureText(t).width,e.height=20,n.font=a,n.fillStyle=o,n.fillText(t,0,15)}function g(e,t){e.width=t.width,e.height=t.height,e.getContext("2d").putImageData(t,0,0)}function d(e){return new Promise(t=>{GM_xmlhttpRequest({url:e,method:"GET",timeout:6e3,onload:e=>{if(200===e.status)try{const a=l(e.responseText),o=a.find(R.join(","))[0].src;let n=o;for(let e of M)if(n=n.replace(e[0],e[1]),n!==o)break;t(n)}catch(e){console.warn(e),t(null)}else console.warn(e),t(null)},ontimeout:e=>{console.warn(e),t(null)}})})}function h(e,t,a,o,n){const[r,s,i]=n;for(let n=0;n<o;++n)for(let o=0;o<a;++o){let c=4*o+n*a*4;t[c]=r[e[c]],t[c+1]=s[e[c+1]],t[c+2]=i[e[c+2]],t[c+3]=e[c+3]}}async function u(e,t){return new Promise(a=>{GM_xmlhttpRequest({url:e,method:"GET",overrideMimeType:"text/plain; charset=x-user-defined",onprogress:e=>{"function"==typeof t&&(-1!==e.total?t(e.loaded/e.total):t(-e.loaded))},onload:t=>{if(200===t.status){const o=t.responseText,n=o.length,r=new Uint8Array(n);for(let e=0;e<n;e++)r[e]=255&o.charCodeAt(e);const s=(t.responseHeaders.match(/content\-type: *(.+)$/m)||["","image/png"])[1];let i;switch(s){case"image/apng":i=".apng";break;case"image/bmp":i=".bmp";break;case"image/gif":i=".gif";break;case"image/x-icon":i=".ico";break;case"image/jpeg":i=".jpg";break;case"image/png":i=".png";break;case"image/svg+xml":i=".svg";break;case"image/tiff":i=".tiff";break;case"image/webp":i=".webp";break;default:if("image"===s.slice(0,5)){let e=s.match(/\/(.*)/);i=e?"."+e:""}else i=(e.match(/\.[^\.]+$/)||[""])[0]}createImageBitmap(new Blob([r],{type:s})).then(e=>{const[t,o]=[e.width,e.height],n=document.createElement("canvas");n.width=t,n.height=o;const r=n.getContext("2d");r.drawImage(e,0,0),e.close(),a({imageData:new ImageData(r.getImageData(0,0,t,o).data,t,o),extension:i})})}else console.warn(t),a(null)},onerror:e=>{console.warn(e),a(null)}})})}async function f(e,t,o={alpha:.5,threshold:.007},n=L){if(e&&t&&e.width===t.width&&e.height===t.height){if(n){const[a,r,s,i]=[e.data.buffer,t.data.buffer,e.width,e.height],c=""+Date.now();return n.onmessage=(e=>{const t=e.data.key,a=n.keyPool[t];a&&a(new ImageData(new Uint8ClampedArray(e.data.diff),e.data.width,e.data.height))}),n.postMessage({img1:a,img2:r,width:s,height:i,init:o,key:c},[a,r]),new Promise(e=>{n.keyPool[c]=e})}{const[n,r,s,i]=[e.data,t.data,e.width,e.height],c=new Uint8ClampedArray(n);return a(n,r,c,s,i,o),new ImageData(c,s,i)}}return null}async function y(e,t){if(e){if(t instanceof Worker){const a=t,[o,n,r]=[e.data.buffer,e.width,e.height],s=""+Date.now();return a.onmessage=(e=>{const t=e.data.key,o=a.keyPool[t];o&&o(new ImageData(new Uint8ClampedArray(e.data.filter),e.data.width,e.data.height))}),await j,a.postMessage({img:o,width:n,height:r,key:s},[o]),new Promise(e=>{a.keyPool[s]=e})}{const a=t,[o,n,r]=[e.data,e.width,e.height],s=new Uint8ClampedArray(o);return h(o,s,n,r,a),new ImageData(s,n,r)}}return null}function w(e,t){if(e.easyCompare&&e.easyCompare.originalImage){const t=e.easyCompare.originalImage;return t.ready&&(t.style.width=`${100*P}%`),t}{const a=p(),o=e=>{null!==e&&e>=0?m(a,`Loading ${(100*e).toFixed(1)}%`):e<0&&m(a,"Loading...")},n=(e,t,o)=>{u(e,t).then(({imageData:t,extension:n})=>{o(t),a.src=e,a.ext=n,g(a,t),a.style.width=`${100*P}%`,a.ready=!0})};return m(a,"Loading..."),a.ready=!1,a.targetImage=e,t.append(a.parentElement),e.easyCompare||(e.easyCompare={}),e.easyCompare.originalImage=a,e.easyCompare.originalImagePromise=(t=>new Promise(async a=>{let o,r,s=e.src;for(let o of M)if(s=s.replace(o[0],o[1]),s!==e.src)return void n(s,t,a);if(r=e.parentElement.href,o=r){for(let e of U)if(o=o.replace(e[0],e[1]),o!==r)break;o.match(/\.png$|\.jpe?g$|\.webp|\.gif|\.bmp|\.svg$/)?n(o,t,a):d(o).then(e=>{n(e||s,t,a)})}else n(s,t,a)})),e.easyCompare.originalImagePromise(o),a}}function b(e,t,a){if(e.src===t.src)return w(e);if(e.easyCompare&&e.easyCompare[t.src]){e.easyCompare[t.src].targetImage=e,e.easyCompare[t.src].baseImage=t;const a=e.easyCompare[t.src];return a.ready&&(a.style.width=`${100*P}%`),a}{const o=p();m(o,"Loading..."),o.ready=!1,o.targetImage=e,o.baseImage=t,o.threshold=-1,o.step=.001,a.append(o.parentElement),e.easyCompare||(e.easyCompare={}),e.easyCompare[t.src]=o,t.easyCompare||(t.easyCompare={}),t.easyCompare[e.src]=o;let n=[0,0];const r=(e,t)=>{null!==e&&e>=0&&null!==t?(n[t]=e,m(o,`Loading ${(50*(n[0]+n[1])).toFixed(1)}%`)):m(o,e<0?"Loading...":"Diffing...")};return w(e,a),w(t,a),Promise.all([e.easyCompare.originalImagePromise(e=>r(e,0)),t.easyCompare.originalImagePromise(e=>r(e,1))]).then(e=>(r(null,null),f(...e,{alpha:.5,threshold:.007}))).then(e=>{null===e?m(o,"Sizes Not Match"):(g(o,e),o.ext=".png",o.threshold=.007,o.style.width=`${100*P}%`,o.ready=!0)}).catch(e=>{console.warn(e),m(o,"Something Went Wrong")}),o}}function k(e,t,a){if(e.easyCompare&&e.easyCompare[t]){const a=e.easyCompare[t];return a.ready&&(a.style.width=`${100*P}%`),a}{const o=p();m(o,"Loading..."),o.ready=!1,o.targetImage=e,a.append(o.parentElement),e.easyCompare||(e.easyCompare={}),e.easyCompare[t]=o;const n=e=>{m(o,null!==e&&e>=0?`Loading ${(100*e).toFixed(1)}%`:e<0?"Loading...":"Filtering...")};return w(e,a),e.easyCompare.originalImagePromise(n).then(e=>(n(null),A[t](e))).then(e=>{g(o,e),o.ext=".png",o.style.width=`${100*P}%`,o.ready=!0}),o}}function x(e){return e.find("canvas:visible")}function C(e){e.attr({fill:"#008000"}).css({cursor:"pointer",opacity:"1"})[0].state=!0}function v(t,a){const o=x(t).hide()[0];(o&&(a=o.targetImage)||a)&&a.easyCompare&&void 0!==a.easyCompare.boxShadow&&e(a).css("box-shadow",a.easyCompare.boxShadow)}function I(a,o,n){function r(){try{h=x(a)[0].targetImage}catch(e){h=void 0,e instanceof TypeError||console.warn(e)}}function s(e="easycompare"){try{const t=x(a)[0],o=t.src||t.toDataURL("image/png").replace(/^data:image\/[^;]/,"data:application/octet-stream"),n=t.ext||"";GM_download({url:o,name:e+n})}catch(e){e instanceof TypeError||console.warn(e)}}function i(t){C=C===t?"none":t;try{const t=x(a).hide()[0];let o;o=e("none"===C?w(t.targetImage,a):k(t.targetImage,C,a)),o.css("outline-color",t.style["outline-color"]).show()}catch(e){e instanceof TypeError||console.warn(e)}}function c(e){try{e&&P<1.95?P+=.1:!e&&P>.15&&(P-=.1);const t=x(a)[0];t.ready&&(t.style.width=`${100*P}%`),n.text(`Zoom: ${parseInt(100*P)}%`).css("opacity","1"),setTimeout(()=>{n.css("opacity","0")},I)}catch(e){e instanceof TypeError||console.warn(e)}}function l(){try{if(1!==P){P=1;const e=x(a)[0];e.ready&&(e.style.width=`${100*P}%`),n.text("Zoom: 100%").css("opacity","1"),setTimeout(()=>{n.css("opacity","0")},I)}}catch(e){e instanceof TypeError||console.warn(e)}}function p(e){try{const t=x(a)[0];let o=t.threshold;if(void 0!==o&&o>=0){const a=o;n.text(`Threshold: ${a.toFixed(4)}`).css("opacity","1"),e?(o+=t.step,o>1&&(o=1)):(o-=t.step,o<0&&(o=0)),t.threshold=-1;const[r,s]=[t.baseImage.easyCompare.originalImage,t.targetImage.easyCompare.originalImage];f(r.getContext("2d").getImageData(0,0,r.width,r.height),s.getContext("2d").getImageData(0,0,s.width,s.height),{alpha:.5,threshold:o}).then(e=>{t.getContext("2d").putImageData(e,0,0),n.text(`Threshold: ${o.toFixed(4)}`).css("opacity","1"),setTimeout(()=>{t.threshold=o,n.css("opacity","0")},I)})}}catch(e){e instanceof TypeError||console.warn(e)}}function m(e){try{const t=x(a)[0];let o=t.step;o&&(t.step=e&&o<=.1?10*o:e?1:!e&&o>=.001?o/10:1e-4,n.text(`Step: ${t.step.toFixed(4)}`).css("opacity","1"),setTimeout(()=>n.css("opacity","0"),I))}catch(e){e instanceof TypeError||console.warn(e)}}function g(){try{v(a,x(a)[0].targetImage)}catch(e){e instanceof TypeError||console.warn(e)}a.find("canvas").toArray().forEach(e=>{const t=e.targetImage;delete t.easyCompare,e.parentElement.remove()})}function d(t,n){try{const r=x(a)[0].targetImage,s=o.index(r);v(a,r);const i=o[t?s-y:s+y]||o[s];e(i).trigger("mouseenter",[n])}catch(e){e instanceof TypeError||console.warn(e)}}t&&t.pause(),a.show()[0].state=!0;let h,u=["red","blue"],y=1,C="none",I=300;o.on("mouseenter.compare",(t,o)=>{const n=t.currentTarget;let r;if(clearTimeout(T),v(a),n.easyCompare||(n.easyCompare={},n.easyCompare.boxShadow=n.style["box-shadow"]),e(n).css({"box-shadow":"0px 0px 8px "+u[0]}),(t.shiftKey||o)&&h)r=e(b(n,h,a)).css("outline-color",u[0]).show();else switch(C){case"none":r=e(w(n,a)).css("outline-color",u[0]).show();break;default:r=e(k(n,C,a)).css("outline-color",u[0]).show()}u.push(u.shift())}).on("mouseleave.compare",e=>{const t=e.currentTarget;T=setTimeout(()=>{v(a,t)},200)}),e(document).on("scroll.compare",t=>{const n=x(a)[0];if(n){const t=e(n.targetImage);t.is(":hover")||(v(a,t[0]),o.find("img:hover").trigger("mousenter"))}}).on("keydown.compare",e=>{switch(e.preventDefault(),e.stopImmediatePropagation(),e.key){case"Escape":$(a,o);break;case"Shift":r();break;case"+":case"=":e.ctrlKey&&c(!0);break;case"-":case"_":e.ctrlKey&&c(!1);break;case"O":case"o":e.ctrlKey&&l();break;case"S":case"s":e.ctrlKey?s():i("solar");break;case"A":case"a":i("s2lar");break;case"I":case"i":case"ArrowUp":p(!0);break;case"K":case"k":case"ArrowDown":p(!1);break;case"J":case"j":case"ArrowLeft":m(!0);break;case"L":case"l":case"ArrowRight":e.ctrlKey?g():m(!1);break;case"Q":case"q":a.css("opacity",.5);break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":y=parseInt(e.key);break;case"0":y=10;break;case"W":case"w":d(!0,e.shiftKey);break;case"E":case"e":d(!1,e.shiftKey)}return!1}).on("keyup.compare",e=>{switch(e.preventDefault(),e.stopImmediatePropagation(),e.key){case"Q":case"q":a.css("opacity","")}return!1})}function $(a,o){t&&t.unpause(),v(a),a.hide()[0].state=!1,o.off("mouseenter.compare").off("mouseleave.compare"),e(document).off("scroll.compare").off("keydown.compare")}if(t){let e=t.prototype||t;const a=e.stopCallback;e.stopCallback=function(e,t,o){var n=this;return!!n.paused||a.call(n,e,t,o)},e.pause=function(){var e=this;e.paused=!0},e.unpause=function(){var e=this;e.paused=!1}}let T,P=1;const M=[[/\.thumb\.jpe?g$/,""],[/\.md\.png$/,".png"],[/\.th\.png$/,".png"],[/_thumb\.png$/,".png"],[/img\.awesome\-hd\.me\/t(\/\d+)?\//,"img.awesome-hd.me/images/"],[/thumbs((?:\d+)?\.imgbox\.com\/.+_)t\.png$/,"images$1o.png"],[/t((?:\d+)?\.pixhost\.to\/)thumbs\//,"img$1images/"],[/t(\.hdbits\.org\/.+)\.jpg$/,"i$1.png"],[/^.*?imagecache\.php\?url=(https?)%3A%2F%2Fthumbs(\d+)?\.imgbox\.com%2F(\w+)%2F(\w+)%2F(\w+)_t\.png/,"$1://images$2.imgbox.com/$3/$4/$5_o.png"]],U=[[/^https?:\/\/anonym\.to\/\?(.*)$/,(e,t)=>decodeURIComponent(t)],[/^https?:\/\/www\.dereferer\.org\/\?(.*)$/,(e,t)=>decodeURIComponent(t)],[/^(?:https?:\/\/pterclub\.com)?\/link\.php\?sign=.+?&target=(.*)$/,(e,t)=>decodeURIComponent(t.replace(/\+/g," ")).replace(/ /g,"%20")],[/^.*?imagecache\.php\?url=(.*)$/,(e,t)=>decodeURIComponent(t.replace(/\+/g," ")).replace(/ /g,"%20")]],R=["#image-viewer-container>img",".image-container img","div.img.big>img","img.mainimage","img#img"],A={solar:e=>y(e,D||F),s2lar:e=>y(e,E||G)};let L,D,E,j,F=GM_getValue("solarCurve"),G=GM_getValue("s2larCurve");F?(F=JSON.parse(F),G=JSON.parse(G)):(F=[Array.from({length:256},(e,t)=>n(t)),Array.from({length:256},(e,t)=>n(t-5)),Array.from({length:256},(e,t)=>n(t+5))],GM_setValue("solarCurve",JSON.stringify(F)),G=[Array.from({length:256},(e,t)=>F[0][[F[0][t]]]),Array.from({length:256},(e,t)=>F[1][[F[1][t]]]),Array.from({length:256},(e,t)=>F[2][[F[2][t]]])],GM_setValue("s2larCurve",JSON.stringify(G))),F=F.map(e=>new Uint8Array(e)),G=G.map(e=>new Uint8Array(e));try{const e=new Blob([c(s,new Function(GM_getResourceText("PixelMatchCore")))],{type:"application/javascript"});L=new Worker(o.createObjectURL(e)),L.keyPool={},o.revokeObjectURL(e);const t=new Blob([c(i,h)],{type:"application/javascript"}),a=o.createObjectURL(t);D=new Worker(a),D.keyPool={};const n=r(D,F);E=new Worker(a),E.keyPool={};const l=r(E,G);o.revokeObjectURL(a),j=Promise.all([n,l])}catch(e){try{const e=`data:application/javascript,${encodeURIComponent(c(s,new Function(GM_getResourceText("PixelMatchCore"))))}`;L=new Worker(e),L.keyPool={};const t=`data:application/javascript,${encodeURIComponent(c(i,h))}`;D=new Worker(t),D.keyPool={};const a=r(D,F);E=new Worker(t),E.keyPool={};const o=r(E,G);j=Promise.all([a,o])}catch(e){L=null,D=null}}const S=e("<div>").css({top:"50%",left:"50%","z-index":2147483647,position:"fixed",transform:"translate(-50%, -50%)",opacity:"0","vertical-align":"middle","pointer-events":"none",transition:"all 0.1s","font-size":"500%",color:"yellow","font-weight":"bold"}),W=e("<div/>").css({id:"easy-compare-overlay",position:"fixed",top:0,right:0,bottom:0,left:0,"z-index":2147483646,"background-color":"rgba(0, 0, 0, 0.75)","pointer-events":"none",display:"none"}).append(S),_=e('<svg xmlns="http://www.w3.org/2000/svg">\n<path id="ld" d="M20 6H10c-2.21 0-4 1.79-4 4v28c0 2.21 1.79 4 4 4h10v4h4V2h-4v4zm0 30H10l10-12v12zM38 6H28v4h10v26L28 24v18h10c2.21 0 4-1.79 4-4V10c0-2.21-1.79-4-4-4z"/>\n</svg>').attr({width:"30",height:"30",viewBox:"0 0 48 48",stroke:"white","stroke-width":"5px",fill:"gray"}).css({position:"fixed",top:"15px",right:"15px","z-index":2147483647,"paint-order":"stroke",opacity:0,transition:"all 0.2s",cursor:"auto"}).on("mouseenter",t=>{e(t.currentTarget).attr({fill:"gray"}).css({opacity:.2}),T=setTimeout(()=>C(e(t.currentTarget)),W[0].state?0:1e3)}).on("mouseleave",t=>{clearTimeout(T),e(t.currentTarget).attr({fill:"gray"}).css({cursor:"auto",opacity:0})[0].state=!1}).click(t=>{if(t.currentTarget.state)switch(W[0].state){case!1:I(W,e(':not("#easy-compare-overlay") img:visible'),S);break;case!0:$(W,e(':not("#easy-compare-overlay") img:visible'))}else{let e=t.clientX,a=t.clientY;const o=document.elementsFromPoint(e,a).find(e=>!["svg","path"].includes(e.tagName));o.click()}}).mousedown(t=>{t.currentTarget.state&&e(t.currentTarget).attr({fill:"#006000"})}).mouseup(t=>{t.currentTarget.state&&e(t.currentTarget).attr({fill:"#008000"})});W[0].state=!1,_[0].state=!1,e("body").append(_).append(W)})(window.$.noConflict(!0),unsafeWindow.Mousetrap,window.pixelmatch,unsafeWindow.URL.createObjectURL?unsafeWindow.URL:unsafeWindow.webkitURL);