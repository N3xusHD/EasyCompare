// ==UserScript==
// @name               Easy Compare
// @description        Compare images
// @version            0.7.2
// @author             Secant (TYT@NexusHD)
// @license            GPL-3.0-or-later
// @supportURL         zzwu@zju.edu.cn
// @contributionURL    https://i.loli.net/2020/02/28/JPGgHc3UMwXedhv.jpg
// @contributionAmount 10
// @include            *
// @require            https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js
// @require            https://bundle.run/pixelmatch@5.1.0
// /require            https://cdn.staticfile.org/pako/1.0.10/pako.min.js
// /require            https://cdn.staticfile.org/upng-js/2.1.0/UPNG.min.js
// @namespace          https://greasyfork.org/users/152136
// @icon               data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23008000'%3E%3Cpath id='ld' d='M20 6H10c-2.21 0-4 1.79-4 4v28c0 2.21 1.79 4 4 4h10v4h4V2h-4v4zm0 30H10l10-12v12zM38 6H28v4h10v26L28 24v18h10c2.21 0 4-1.79 4-4V10c0-2.21-1.79-4-4-4z'/%3E%3C/svg%3E
// @grant              GM_xmlhttpRequest
// @grant              GM_download
// @grant              unsafewindow
// @connect            hdbits.org
// @connect            awesome-hd.me
// @connect            ptpimg.me
// @connect            imgbox.com
// @connect            malzo.com
// @connect            imagebam.com
// @connect            pixhost.to
// @connect            loli.net
// @connect            funkyimg.com
// @connect            ilikeshots.club
// @connect            z4a.net
// @connect            picgd.com
// @connect            tu.totheglory.im
// @connect            tpimg.ccache.org
// @connect            pterclub.com
// @connect            catbox.moe
// @connect            *
// ==/UserScript==
(async function(e,t,a,r,o){"use strict";async function n(e){return new Promise(e=>{$.onmessage=(t=>{e(t.data.result)}),$.postMessage({Rc:x.buffer,Gc:v.buffer,Bc:C.buffer},[x.buffer,v.buffer,C.buffer])})}function s(e){return new Promise(t=>{GM_xmlhttpRequest({url:e,method:"GET",timeout:6e3,onload:e=>{if(200===e.status)try{const a=m(e.responseText),r=a.find(A.join(","))[0].src;let o=r;for(let e of E)if(o=o.replace(e[0],e[1]),o!==r)break;t(o)}catch(e){console.warn(e),t(null)}else console.warn(e),t(null)},ontimeout:e=>{console.warn(e),t(null)}})})}async function i(e,t){const a=await new Promise(a=>{GM_xmlhttpRequest({url:e,method:"GET",overrideMimeType:"text/plain; charset=x-user-defined",onprogress:e=>{-1!==e.total?t(e.loaded/e.total):t(-e.loaded)},onload:e=>{if(200===e.status){const t=e.responseText,r=t.length,o=new Uint8Array(r);for(let e=0;e<r;e++)o[e]=t.charCodeAt(e);a(o)}else console.warn(e),a(null)},onerror:e=>{console.warn(e),a(null)}})});return a?new Promise(async e=>{const t=o.createObjectURL(new Blob([a],{type:"image/png"})),r=new Image,n=document.createElement("canvas"),s=n.getContext("2d");r.onload=function(){o.revokeObjectURL(t);const[a,r]=[this.width,this.height];n.width=a,n.height=r,s.drawImage(this,0,0,a,r),e({raw:s.getImageData(0,0,a,r).data.buffer,width:a,height:r})},r.onerror=function(){e(null)},r.src=t}):null}function c(e,t,a,r){for(let o=0;o<r;++o)for(let r=0;r<a;++r){let n=4*r+o*a*4;t[n]=x[e[n]],t[n+1]=v[e[n+1]],t[n+2]=C[e[n+2]],t[n+3]=e[n+3]}}async function l(e,t,a=$){const r=await i(e,t);if(r){if(t(null),a){const[e,t,n]=[r.raw,r.width,r.height],s=""+Date.now();return a.onmessage=(e=>{const t=e.data.key,r=a.keyPool[t];if(r){const n=document.createElement("canvas"),[s,i]=[e.data.width,e.data.height];[n.width,n.height]=[s,i];const c=n.getContext("2d");c.putImageData(new ImageData(new Uint8ClampedArray(e.data.filter),s,i),0,0),n.toBlob(e=>{r(o.createObjectURL(e)),delete a.keyPool[t]},"image/png",1)}}),a.postMessage({img:e,width:t,height:n,key:s},[e]),new Promise(e=>{a.keyPool[s]=e})}{const[e,t,a]=[new Uint8ClampedArray(r.raw),r.width,r.height],n=document.createElement("canvas");[n.width,n.height]=[t,a];const s=n.getContext("2d"),i=s.createImageData(t,a);return c(e,i.data,t,a),s.putImageData(i,0,0),new Promise(e=>{n.toBlob(t=>{e(o.createObjectURL(t))},"image/png",1)})}}}async function d(e,t,r,n={alpha:.5,threshold:.007},s=I){const[c,l]=await Promise.all([i(e,e=>r(e,0)),i(t,e=>r(e,1))]);if(c&&l&&c.width===l.width&&c.height===l.height){if(r(null,null),s){const[e,t,a,r]=[c.raw,l.raw,c.width,c.height],i=""+Date.now();return s.onmessage=(e=>{const t=e.data.key,a=s.keyPool[t];if(a){const r=document.createElement("canvas"),[n,i]=[e.data.width,e.data.height];[r.width,r.height]=[n,i];const c=r.getContext("2d");c.putImageData(new ImageData(new Uint8ClampedArray(e.data.diff),n,i),0,0),r.toBlob(e=>{a(o.createObjectURL(e)),delete s.keyPool[t]},"image/png",1)}}),s.postMessage({img1:e,img2:t,width:a,height:r,init:n,key:i},[e,t]),new Promise(e=>{s.keyPool[i]=e})}{const[e,t,r,s]=[new Uint8ClampedArray(c.raw),new Uint8ClampedArray(l.raw),c.width,c.height],i=document.createElement("canvas");[i.width,i.height]=[r,s];const d=i.getContext("2d"),m=d.createImageData(r,s);return a(e,t,m.data,r,s,n),d.putImageData(m,0,0),new Promise(e=>{i.toBlob(t=>{e(o.createObjectURL(t))},"image/png",1)})}}return null}function m(t){return e(t,document.implementation.createHTMLDocument("virtual"))}function g(e,t,a=20){return`data:image/svg+xml,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' height="${a}" width="${t}"><text x="0" y="15" fill="white">${e}</text></svg>`)}`}function h(t,a="red"){const r=e("<figure/>").css({width:"fit-content",position:"fixed",top:"50%",left:"50%",margin:"0","vertical-align":"middle"}),o=e(`<img src="${t}"/>`).css({display:"none",transform:"translate(-50%, -50%)",opacity:"1",outline:"3px solid "+a,"outline-offset":"2px"});return r.append(o),o}function f(e){e.attr({fill:"#008000"}).css({cursor:"pointer",opacity:"1"})[0].state=!0}function p(t,a){const r=t.find("img:visible").hide()[0];(r&&(a=r.targetImage)||a)&&a.easyCompare&&void 0!==a.easyCompare.boxShadow&&e(a).css("box-shadow",a.easyCompare.boxShadow)}function u(e,t){if(e.easyCompare&&e.easyCompare.originalImage){const t=e.easyCompare.originalImage;return t.ready&&(t.style.width=`${100*P}%`),t}{const a=h(g("Loading...",80))[0];return a.ready=!1,a.targetImage=e,t.append(a.parentElement),e.easyCompare||(e.easyCompare={}),e.easyCompare.originalImage=a,e.easyCompare.originalImagePromise=new Promise(t=>{let r,o,n=e.src;for(let r of E)n=n.replace(r[0],r[1]),n!==e.src&&(a.src=n,a.style.width=`${100*P}%`,a.ready=!0,t(a));if(o=e.parentElement.href,r=o){for(let e of M)if(r=r.replace(e[0],e[1]),r!==o)break;r.match(/\.png$|\.jpe?g$|\.webp|\.gif|\.bmp|\.svg$/)?(a.src=r,a.style.width=`${100*P}%`,a.ready=!0,t(a)):s(r).then(e=>{a.src=e||n,a.style.width=`${100*P}%`,a.ready=!0,t(a)})}else a.src=n,a.style.width=`${100*P}%`,a.ready=!0,t(a)}),a}}function y(e,t,a){if(e.src===t.src)return u(e);if(e.easyCompare&&e.easyCompare[t.src]){e.easyCompare[t.src].targetImage=e,e.easyCompare[t.src].baseImage=t;const a=e.easyCompare[t.src];return a.ready&&(a.style.width=`${100*P}%`),a}{const r=h(g("Loading...",80))[0];r.ready=!1,r.targetImage=e,r.baseImage=t,r.threshold=-1,r.step=.001,a.append(r.parentElement),e.easyCompare||(e.easyCompare={}),e.easyCompare[t.src]=r,t.easyCompare||(t.easyCompare={}),t.easyCompare[e.src]=r;let o=[0,0];const n=(e,t)=>{null!==e&&e>=0&&null!==t?(o[t]=e,r.src=g(`Loading ${(50*(o[0]+o[1])).toFixed(1)}%`,120)):r.src=g(e<0?"Loading...":"Diffing...",80)};return u(e,a),u(t,a),Promise.all([e.easyCompare.originalImagePromise,t.easyCompare.originalImagePromise]).then(([{src:e},{src:t}])=>d(e,t,n,{alpha:.5,threshold:.007})).then(e=>{null===e?r.src=g("Sizes Not Match",120):(r.onload=(()=>{r.style.width=`${100*P}%`,r.ready=!0}),r.src=e,r.threshold=.007)}).catch(e=>{console.warn(e),r.src=g("Sth. Went Wrong",120)}),r}}function w(e,t,a){if(e.easyCompare&&e.easyCompare[t]){const a=e.easyCompare[t];return a.ready&&(a.style.width=`${100*P}%`),a}{const r=h(g("Loading...",80))[0];r.ready=!1,r.targetImage=e,a.append(r.parentElement),e.easyCompare||(e.easyCompare={}),e.easyCompare[t]=r;const o=e=>{r.src=null!==e&&e>=0?g(`Loading ${(100*e).toFixed(1)}%`,120):g(e<0?"Loading...":"Filtering...",80)};return u(e,a),e.easyCompare.originalImagePromise.then(e=>{R[t](e.src,o).then(e=>{r.onload=(()=>{r.style.width=`${100*P}%`,r.ready=!0}),r.src=e})}),r}}function b(a,r,n){t&&t.pause(),a.show()[0].state=!0;let s,i=["red","blue"],c=1,l="none";r.on("mouseenter.compare",(t,r)=>{const o=t.currentTarget;let n;if(clearTimeout(j),p(a),o.easyCompare||(o.easyCompare={},o.easyCompare.boxShadow=o.style["box-shadow"]),e(o).css({"box-shadow":"0px 0px 8px "+i[0]}),(t.shiftKey||r)&&s)n=e(y(o,s,a)).css("outline-color",i[0]).show();else switch(l){case"none":n=e(u(o,a)).css("outline-color",i[0]).show();break;default:n=e(w(o,l,a)).css("outline-color",i[0]).show()}i.push(i.shift())}).on("mouseleave.compare",e=>{const t=e.currentTarget;j=setTimeout(()=>{p(a,t)},200)}),e(document).on("scroll.compare",t=>{const o=a.find("img:visible")[0];if(o){const t=e(o.targetImage);t.is(":hover")||(p(a,t[0]),r.find("img:hover").trigger("mousenter"))}}).on("keydown.compare",t=>{switch(t.preventDefault(),t.stopImmediatePropagation(),t.key){case"Escape":k(a,r);break;case"Shift":try{const e=r.index(a.find("img:visible")[0].targetImage);s=r[e]}catch(e){s=void 0,e instanceof TypeError||console.warn(e)}break;case"+":case"=":if(t.ctrlKey)try{P<=.9?P+=.1:P=1;const e=a.find("img:visible")[0];e.ready&&(e.style.width=`${100*P}%`)}catch(e){e instanceof TypeError||console.warn(e)}break;case"-":case"_":if(t.ctrlKey)try{P>=.2?P-=.1:P=.1;const e=a.find("img:visible")[0];e.ready&&(e.style.width=`${100*P}%`)}catch(e){e instanceof TypeError||console.warn(e)}break;case"O":case"o":if(t.ctrlKey)try{if(1!==P){P=1;const e=a.find("img:visible")[0];e.ready&&(e.style.width=`${100*P}%`)}}catch(e){e instanceof TypeError||console.warn(e)}break;case"S":case"s":if(t.ctrlKey)try{const e=a.find("img:visible")[0];GM_download({url:e.src,name:"easycompare.png",onerror:t=>{if("Invalid scheme"===t.error){const t=document.createElement("a");t.href=e.src,t.download="easycompare.png",t.click()}}})}catch(e){e instanceof TypeError||console.warn(e)}else{l="rainbow"===l?"none":"rainbow";try{const t=a.find("img:visible").hide()[0];let r;r=e("none"===l?u(t.targetImage,a):w(t.targetImage,l,a)),r.css("outline-color",t.style["outline-color"]).show()}catch(e){e instanceof TypeError||console.warn(e)}}break;case"I":case"i":case"ArrowUp":try{const e=a.find("img:visible")[0];let t=e.threshold;if(void 0!==t&&t>=0){const a=t;n.text(`Threshold: ${a.toFixed(4)}`).css("opacity","1"),t+=e.step,t>1&&(t=1),e.threshold=-1,d(e.baseImage.easyCompare.originalImage.src,e.targetImage.easyCompare.originalImage.src,(e,t)=>{},{alpha:.5,threshold:t}).then(r=>{let o;null===r?(e.src=g("Sizes Not Match",120),o=a,setTimeout(()=>{e.threshold=a},300)):(e.src=r,o=t,setTimeout(()=>{e.threshold=t},300)),n.text(`Threshold: ${o.toFixed(4)}`).css("opacity","1"),setTimeout(()=>n.css("opacity","0"),300)})}}catch(e){e instanceof TypeError||console.warn(e)}break;case"K":case"k":case"ArrowDown":try{const e=a.find("img:visible")[0];let t=e.threshold;if(void 0!==t&&t>=0){const a=t;n.text(`Threshold: ${a.toFixed(4)}`).css("opacity","1"),t-=e.step,t<0&&(t=0),e.threshold=-1,d(e.baseImage.easyCompare.originalImage.src,e.targetImage.easyCompare.originalImage.src,(e,t)=>{},{alpha:.5,threshold:t}).then(r=>{let o;null===r?(e.src=g("Sizes Not Match",120),o=a,setTimeout(()=>{e.threshold=a},300)):(e.src=r,o=t,setTimeout(()=>{e.threshold=t},300)),n.text(`Threshold: ${o.toFixed(4)}`).css("opacity","1"),setTimeout(()=>n.css("opacity","0"),300)})}}catch(e){e instanceof TypeError||console.warn(e)}break;case"J":case"j":case"ArrowLeft":try{const e=a.find("img:visible")[0];switch(e.step){case 1e-4:e.step=.001;break;case.001:e.step=.01;break;case.01:e.step=.1;break;case.1:e.step=1}e.step&&(n.text(`Step: ${e.step.toFixed(4)}`).css("opacity","1"),setTimeout(()=>n.css("opacity","0"),300))}catch(e){e instanceof TypeError||console.warn(e)}break;case"L":case"l":case"ArrowRight":if(t.ctrlKey){try{p(a,a.find("img:visible")[0].targetImage)}catch(e){e instanceof TypeError||console.warn(e)}a.find("img").toArray().forEach(e=>{const t=e.targetImage;delete t.easyCompare,o.revokeObjectURL(e.src),e.parentElement.remove()})}else try{const e=a.find("img:visible")[0];switch(e.step){case 1:e.step=.1;break;case.1:e.step=.01;break;case.01:e.step=.001;break;case.001:e.step=1e-4}e.step&&(n.text(`Step: ${e.step.toFixed(4)}`).css("opacity","1"),setTimeout(()=>n.css("opacity","0"),300))}catch(e){e instanceof TypeError||console.warn(e)}break;case"Q":case"q":a.css("opacity",.5);break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":c=parseInt(t.key);break;case"0":c=10;break;case"E":case"e":try{const o=a.find("img:visible")[0].targetImage,n=r.index(o);p(a,o);const s=r[n+c]||r[n];e(s).trigger("mouseenter",[t.shiftKey])}catch(e){e instanceof TypeError||console.warn(e)}break;case"W":case"w":try{const o=a.find("img:visible")[0].targetImage,n=r.index(o);p(a,o);const s=r[n-c]||r[n];e(s).trigger("mouseenter",[t.shiftKey])}catch(e){e instanceof TypeError||console.warn(e)}}return!1}).on("keyup.compare",e=>{switch(e.preventDefault(),e.stopImmediatePropagation(),e.key){case"Q":case"q":a.css("opacity","")}return!1})}function k(a,r){t&&t.unpause(),p(a),a.hide()[0].state=!1,r.off("mouseenter.compare").off("mouseleave.compare"),e(document).off("scroll.compare").off("keydown.compare")}const[x,v,C]=[new Uint8Array([0,2,9,21,37,56,78,101,125,149,172,193,212,228,241,250,254,255,252,246,235,222,206,188,168,148,127,106,86,67,49,34,22,12,5,1,0,1,6,14,24,36,50,66,82,100,118,136,154,171,188,203,216,228,238,245,251,254,255,254,251,246,239,230,219,207,194,180,165,149,134,118,103,88,73,60,48,36,26,18,11,6,2,0,0,1,4,8,14,22,30,40,51,63,75,88,102,115,129,143,156,170,182,194,205,216,225,233,240,246,250,253,255,255,254,252,248,243,237,230,221,212,201,190,179,166,154,141,128,114,101,89,76,65,54,43,34,25,18,12,7,3,1,0,0,2,5,9,15,22,30,39,50,61,73,85,99,112,126,140,153,167,180,192,204,215,225,233,241,247,251,254,255,255,253,249,244,237,229,219,207,195,182,167,152,137,121,106,90,75,61,48,36,25,16,9,4,1,0,1,4,10,17,27,39,52,67,84,101,119,137,155,173,189,205,219,231,241,249,254,255,254,250,243,233,221,206,188,169,149,128,107,87,67,49,33,20,9,3,0,1,5,14,27,43,62,83,106,130,154,177,199,218,234,246,253]),new Uint8Array([60,39,22,10,2,0,2,9,21,37,56,78,101,125,149,172,193,212,228,241,250,254,255,252,246,235,222,206,188,168,148,127,106,86,67,49,34,22,12,5,1,0,1,6,14,24,36,50,66,82,100,118,136,154,171,188,203,216,228,238,245,251,254,255,254,251,246,239,230,219,207,194,180,165,149,134,118,103,88,73,60,48,36,26,18,11,6,2,0,0,1,4,8,14,22,30,40,51,63,75,88,102,115,129,143,156,170,182,194,205,216,225,233,240,246,250,253,255,255,254,252,248,243,237,230,221,212,201,190,179,166,154,141,128,114,101,89,76,65,54,43,34,25,18,12,7,3,1,0,0,2,5,9,15,22,30,39,50,61,73,85,99,112,126,140,153,167,180,192,204,215,225,233,241,247,251,254,255,255,253,249,244,237,229,219,207,195,182,167,152,137,121,106,90,75,61,48,36,25,16,9,4,1,0,1,4,10,17,27,39,52,67,84,101,119,137,155,173,189,205,219,231,241,249,254,255,254,250,243,233,221,206,188,169,149,128,107,87,67,49,33,20,9,3,0,1,5,14,27,43,62,83,106,130,154,177]),new Uint8Array([56,78,101,125,149,172,193,212,228,241,250,254,255,252,246,235,222,206,188,168,148,127,106,86,67,49,34,22,12,5,1,0,1,6,14,24,36,50,66,82,100,118,136,154,171,188,203,216,228,238,245,251,254,255,254,251,246,239,230,219,207,194,180,165,149,134,118,103,88,73,60,48,36,26,18,11,6,2,0,0,1,4,8,14,22,30,40,51,63,75,88,102,115,129,143,156,170,182,194,205,216,225,233,240,246,250,253,255,255,254,252,248,243,237,230,221,212,201,190,179,166,154,141,128,114,101,89,76,65,54,43,34,25,18,12,7,3,1,0,0,2,5,9,15,22,30,39,50,61,73,85,99,112,126,140,153,167,180,192,204,215,225,233,241,247,251,254,255,255,253,249,244,237,229,219,207,195,182,167,152,137,121,106,90,75,61,48,36,25,16,9,4,1,0,1,4,10,17,27,39,52,67,84,101,119,137,155,173,189,205,219,231,241,249,254,255,254,250,243,233,221,206,188,169,149,128,107,87,67,49,33,20,9,3,0,1,5,14,27,43,62,83,106,130,154,177,199,218,234,246,253,255,253,245,233,216])];let I,$;const T='const defaultOptions={threshold:.1,includeAA:!1,alpha:.1,aaColor:[255,255,0],diffColor:[255,0,0],diffMask:!1};function pixelmatch(a,b,c,d,e,f){if(!isPixelData(a)||!isPixelData(b)||c&&!isPixelData(c))throw new Error("Image data: Uint8Array, Uint8ClampedArray or Buffer expected.");if(a.length!==b.length||c&&c.length!==a.length)throw new Error("Image sizes do not match.");if(a.length!==4*(d*e))throw new Error("Image data size does not match width/height.");f=Object.assign({},defaultOptions,f);const g=d*e,h=new Uint32Array(a.buffer,a.byteOffset,g),j=new Uint32Array(b.buffer,b.byteOffset,g);let k=!0;for(let l=0;l<g;l++)if(h[l]!==j[l]){k=!1;break}if(k){if(c&&!f.diffMask)for(let b=0;b<g;b++)drawGrayPixel(a,4*b,f.alpha,c);return 0}const l=35215*f.threshold*f.threshold;let m=0;const[n,o,p]=f.aaColor,[q,r,s]=f.diffColor;for(let g=0;g<e;g++)for(let h=0;h<d;h++){const i=4*(g*d+h),j=colorDelta(a,b,i,i);j>l?!f.includeAA&&(antialiased(a,h,g,d,e,b)||antialiased(b,h,g,d,e,a))?c&&!f.diffMask&&drawPixel(c,i,n,o,p):(c&&drawPixel(c,i,q,r,s),m++):c&&!f.diffMask&&drawGrayPixel(a,i,f.alpha,c)}return m}function isPixelData(a){return ArrayBuffer.isView(a)&&1===a.constructor.BYTES_PER_ELEMENT}function antialiased(a,b,c,d,e,f){const g=Math.max(b-1,0),h=Math.max(c-1,0),i=Math.min(b+1,d-1),j=Math.min(c+1,e-1);let k,l,m,n,o=b===g||b===i||c===h||c===j?1:0,p=0,q=0;for(let r=g;r<=i;r++)for(let e=h;e<=j;e++){if(r===b&&e===c)continue;const f=colorDelta(a,a,4*(c*d+b),4*(e*d+r),!0);if(0!==f)f<p?(p=f,k=r,l=e):f>q&&(q=f,m=r,n=e);else if(o++,2<o)return!1}return 0!==p&&0!==q&&(hasManySiblings(a,k,l,d,e)&&hasManySiblings(f,k,l,d,e)||hasManySiblings(a,m,n,d,e)&&hasManySiblings(f,m,n,d,e))}function hasManySiblings(a,b,c,d,e){const f=Math.max(b-1,0),g=Math.max(c-1,0),h=Math.min(b+1,d-1),i=Math.min(c+1,e-1),j=4*(c*d+b);let k=b===f||b===h||c===g||c===i?1:0;for(let l=f;l<=h;l++)for(let e=g;e<=i;e++){if(l===b&&e===c)continue;const f=4*(e*d+l);if(a[j]===a[f]&&a[j+1]===a[f+1]&&a[j+2]===a[f+2]&&a[j+3]===a[f+3]&&k++,2<k)return!0}return!1}function colorDelta(a,b,c,d,e){let f=a[c+0],g=a[c+1],h=a[c+2],j=a[c+3],k=b[d+0],l=b[d+1],m=b[d+2],n=b[d+3];if(j===n&&f===k&&g===l&&h===m)return 0;255>j&&(j/=255,f=blend(f,j),g=blend(g,j),h=blend(h,j)),255>n&&(n/=255,k=blend(k,n),l=blend(l,n),m=blend(m,n));const o=rgb2y(f,g,h)-rgb2y(k,l,m);if(e)return o;const p=rgb2i(f,g,h)-rgb2i(k,l,m),i=rgb2q(f,g,h)-rgb2q(k,l,m);return .5053*o*o+.299*p*p+.1957*i*i}function rgb2y(a,c,d){return .29889531*a+.58662247*c+.11448223*d}function rgb2i(a,c,d){return .59597799*a-.2741761*c-.32180189*d}function rgb2q(a,c,d){return .21147017*a-.52261711*c+.31114694*d}function blend(b,c){return 255+(b-255)*c}function drawPixel(a,c,d,e,f){a[c+0]=d,a[c+1]=e,a[c+2]=f,a[c+3]=255}function drawGrayPixel(a,c,d,e){const f=a[c+0],h=a[c+1],g=a[c+2],b=blend(rgb2y(f,h,g),d*a[c+3]/255);drawPixel(e,c,b,b,b)}self.onmessage=a=>{img1=new Uint8ClampedArray(a.data.img1),img2=new Uint8ClampedArray(a.data.img2),diff=new Uint8ClampedArray(img1),width=a.data.width,height=a.data.height,init=a.data.init,key=a.data.key;try{pixelmatch(img1,img2,diff,width,height,init),self.postMessage({diff:diff.buffer,width:width,height:height,key:key},[diff.buffer])}catch(a){console.warn(a),self.postMessage({diff:null,key:key})}};',U="let Rc,Gc,Bc;self.onmessage=a=>{const b=a.data.key;if(a.data.Rc&&a.data.Gc&&a.data.Bc)Rc=new Uint8ClampedArray(a.data.Rc),Gc=new Uint8ClampedArray(a.data.Gc),Bc=new Uint8ClampedArray(a.data.Bc),self.postMessage({result:!0});else{const c=new Uint8ClampedArray(a.data.img),d=new Uint8ClampedArray(c),e=a.data.width,f=a.data.height;try{for(let a=0;a<f;++a)for(let b,f=0;f<e;++f)b=4*f+4*(a*e),d[b]=Rc[c[b]],d[b+1]=Gc[c[b+1]],d[b+2]=Bc[c[b+2]],d[b+3]=c[b+3];self.postMessage({filter:d.buffer,width:e,height:f,key:b},[d.buffer])}catch(a){console.warn(a),self.postMessage({filter:null,key:b})}}};";try{const e=new Blob([T],{type:"application/javascript"});I=new Worker(o.createObjectURL(e)),I.keyPool={},o.revokeObjectURL(e);const t=new Blob([U],{type:"application/javascript"});$=new Worker(o.createObjectURL(t)),$.keyPool={},o.revokeObjectURL(t),await n($)}catch(e){try{const e=`data:application/javascript,${encodeURIComponent(T)}`;I=new Worker(e),I.keyPool={};const t=`data:application/javascript,${encodeURIComponent(U)}`;$=new Worker(t),$.keyPool={},await n($)}catch(e){I=null,$=null}}if(t){let e=t.prototype||t;const a=e.stopCallback;e.stopCallback=function(e,t,r){var o=this;return!!o.paused||a.call(o,e,t,r)},e.pause=function(){var e=this;e.paused=!0},e.unpause=function(){var e=this;e.paused=!1}}let j,P=1;const E=[[/\.thumb\.jpe?g$/,""],[/\.md\.png$/,".png"],[/\.th\.png$/,".png"],[/_thumb\.png$/,".png"],[/img\.awesome\-hd\.me\/t(\/\d+)?\//,"img.awesome-hd.me/images/"],[/thumbs((?:\d+)?\.imgbox\.com\/.+_)t\.png$/,"images$1o.png"],[/t((?:\d+)?\.pixhost\.to\/)thumbs\//,"img$1images/"],[/t(\.hdbits\.org\/.+)\.jpg$/,"i$1.png"],[/^.*?imagecache\.php\?url=(https?)%3A%2F%2Fthumbs(\d+)?\.imgbox\.com%2F(\w+)%2F(\w+)%2F(\w+)_t\.png/,"$1://images$2.imgbox.com/$3/$4/$5_o.png"]],M=[[/^https?:\/\/anonym\.to\/\?(.*)$/,(e,t)=>decodeURIComponent(t)],[/^https?:\/\/www\.dereferer\.org\/\?(.*)$/,(e,t)=>decodeURIComponent(t)],[/^(?:https?:\/\/pterclub\.com)?\/link\.php\?sign=.+?&target=(.*)$/,(e,t)=>decodeURIComponent(t.replace(/\+/g," ")).replace(/ /g,"%20")],[/^.*?imagecache\.php\?url=(.*)$/,(e,t)=>decodeURIComponent(t.replace(/\+/g," ")).replace(/ /g,"%20")]],A=["#image-viewer-container>img",".image-container img","div.img.big>img","img.mainimage","img#img"],R={rainbow:l},L=e("<div/>").css({position:"fixed",top:0,right:0,bottom:0,left:0,"z-index":2147483646,"background-color":"rgba(0, 0, 0, 0.75)","pointer-events":"none",display:"none"}),D=e("<div>").css({top:"50%",left:"50%","z-index":2147483647,position:"fixed",transform:"translate(-50%, -50%)",opacity:"0","vertical-align":"middle","pointer-events":"none",transition:"all 0.1s","font-size":"500%",color:"yellow","font-weight":"bold"});L.append(D);const O=e('<svg xmlns="http://www.w3.org/2000/svg">\n<path id="ld" d="M20 6H10c-2.21 0-4 1.79-4 4v28c0 2.21 1.79 4 4 4h10v4h4V2h-4v4zm0 30H10l10-12v12zM38 6H28v4h10v26L28 24v18h10c2.21 0 4-1.79 4-4V10c0-2.21-1.79-4-4-4z"/>\n</svg>').attr({width:"30",height:"30",viewBox:"0 0 48 48",stroke:"white","stroke-width":"5px",fill:"gray"}).css({position:"fixed",top:"15px",right:"15px","z-index":2147483647,"paint-order":"stroke",opacity:0,transition:"all 0.2s",cursor:"auto"}).on("mouseenter",t=>{e(t.currentTarget).attr({fill:"gray"}).css({opacity:.2}),j=setTimeout(()=>f(e(t.currentTarget)),L[0].state?0:1e3)}).on("mouseleave",t=>{clearTimeout(j),e(t.currentTarget).attr({fill:"gray"}).css({cursor:"auto",opacity:0})[0].state=!1}).click(t=>{if(t.currentTarget.state)switch(L[0].state){case!1:b(L,e("img:visible:not(.easy-compare-image)"),D);break;case!0:k(L,e("img:visible:not(.easy-compare-image)"))}else{let e=t.clientX,a=t.clientY;const r=document.elementsFromPoint(e,a).find(e=>!["svg","path"].includes(e.tagName));r.click()}}).mousedown(t=>{t.currentTarget.state&&e(t.currentTarget).attr({fill:"#006000"})}).mouseup(t=>{t.currentTarget.state&&e(t.currentTarget).attr({fill:"#008000"})});L[0].state=!1,O[0].state=!1,e("body").append(O).append(L)})(window.$.noConflict(!0),unsafeWindow.Mousetrap,window.pixelmatch,window.UPNG,unsafeWindow.URL.createObjectURL?unsafeWindow.URL:unsafeWindow.webkitURL);