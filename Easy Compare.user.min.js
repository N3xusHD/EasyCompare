// ==UserScript==
// @name               Easy Compare
// @description        Compare images
// @version            0.8.3
// @author             Secant (TYT@NexusHD)
// @license            GPL-3.0-or-later
// @supportURL         zzwu@zju.edu.cn
// @contributionURL    https://i.loli.net/2020/02/28/JPGgHc3UMwXedhv.jpg
// @contributionAmount 10
// @include            *
// @require            https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js
// @require            https://bundle.run/pixelmatch@5.1.0
// @namespace          https://greasyfork.org/users/152136
// @icon               data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23008000'%3E%3Cpath id='ld' d='M20 6H10c-2.21 0-4 1.79-4 4v28c0 2.21 1.79 4 4 4h10v4h4V2h-4v4zm0 30H10l10-12v12zM38 6H28v4h10v26L28 24v18h10c2.21 0 4-1.79 4-4V10c0-2.21-1.79-4-4-4z'/%3E%3C/svg%3E
// @grant              GM_xmlhttpRequest
// @grant              GM_download
// @grant              GM_getValue
// @grant              GM_setValue
// @grant              unsafewindow
// @connect            hdbits.org
// @connect            awesome-hd.me
// @connect            ptpimg.me
// @connect            imgbox.com
// @connect            malzo.com
// @connect            imagebam.com
// @connect            pixhost.to
// @connect            loli.net
// @connect            funkyimg.com
// @connect            ilikeshots.club
// @connect            z4a.net
// @connect            picgd.com
// @connect            tu.totheglory.im
// @connect            tpimg.ccache.org
// @connect            pterclub.com
// @connect            catbox.moe
// @connect            *
// ==/UserScript==
(async function(e,t,a,r){"use strict";function n(e,t=5,a=5.5){const r=a*Math.PI-128/t,n=-1/4194304*r,o=3/32768*r,s=1/t;return Math.round(127.9999*Math.sin(n*e**3+o*e**2+s*e-Math.PI/2)+127.5)||0}async function o(e,[t,a,r]){return new Promise(n=>{e.onmessage=(e=>{n(e.data.result)}),e.postMessage({R:t.buffer,G:a.buffer,B:r.buffer},[t.buffer,a.buffer,r.buffer])})}function s(t){return e(t,document.implementation.createHTMLDocument("virtual"))}function i(t="red"){const a=e("<figure/>").css({width:"fit-content",position:"fixed",top:"50%",left:"50%",margin:"0","vertical-align":"middle"}),r=e("<canvas/>").css({display:"none",transform:"translate(-50%, -50%)",opacity:"1",outline:"3px solid "+t,"outline-offset":"2px"});a.append(r);const n=r[0],o=n.getContext("2d");return{canvas:n,context:o}}function c(e){return new Promise(t=>{GM_xmlhttpRequest({url:e,method:"GET",timeout:6e3,onload:e=>{if(200===e.status)try{const a=s(e.responseText),r=a.find(T.join(","))[0].src;let n=r;for(let e of v)if(n=n.replace(e[0],e[1]),n!==r)break;t(n)}catch(e){console.warn(e),t(null)}else console.warn(e),t(null)},ontimeout:e=>{console.warn(e),t(null)}})})}function l(e,t,a,r,n){const[o,s,i]=n;for(let n=0;n<r;++n)for(let r=0;r<a;++r){let c=4*r+n*a*4;t[c]=o[e[c]],t[c+1]=s[e[c+1]],t[c+2]=i[e[c+2]],t[c+3]=e[c+3]}}async function f(e,t){return new Promise(a=>{GM_xmlhttpRequest({url:e,method:"GET",overrideMimeType:"text/plain; charset=x-user-defined",onprogress:e=>{"function"==typeof t&&(-1!==e.total?t(e.loaded/e.total):t(-e.loaded))},onload:e=>{if(200===e.status){const t=e.responseText,r=t.length,n=new Uint8Array(r);for(let e=0;e<r;e++)n[e]=255&t.charCodeAt(e);const o=(e.responseHeaders.match(/content\-type: *(.+)(\n|$)/)||[,"image/png"])[1];createImageBitmap(new Blob([n],{type:o})).then(e=>{const[t,r]=[e.width,e.height],n=document.createElement("canvas");n.width=t,n.height=r;const o=n.getContext("2d");o.drawImage(e,0,0),e.close(),a(new ImageData(o.getImageData(0,0,t,r).data,t,r))})}else console.warn(e),a(null)},onerror:e=>{console.warn(e),a(null)}})})}async function d(e,t,r={alpha:.5,threshold:.007},n=P){if(e&&t&&e.width===t.width&&e.height===t.height){if(n){const[a,o,s,i]=[e.data.buffer,t.data.buffer,e.width,e.height],c=""+Date.now();return n.onmessage=(e=>{const t=e.data.key,a=n.keyPool[t];a&&a(new ImageData(new Uint8ClampedArray(e.data.diff),s,i))}),n.postMessage({img1:a,img2:o,width:s,height:i,init:r,key:c},[a,o]),new Promise(e=>{n.keyPool[c]=e})}{const[n,o,s,i]=[e.data,t.data,e.width,e.height],c=new Uint8ClampedArray(n);return a(n,o,c,s,i,r),new ImageData(c,s,i)}}return null}async function g(e,t){if(e){if(t instanceof Worker){const a=t,[r,n,o]=[e.data.buffer,e.width,e.height],s=""+Date.now();return a.onmessage=(e=>{const t=e.data.key,r=a.keyPool[t];r&&r(new ImageData(new Uint8ClampedArray(e.data.filter),n,o))}),await U,a.postMessage({img:r,width:n,height:o,key:s},[r]),new Promise(e=>{a.keyPool[s]=e})}{const a=t,[r,n,o]=[e.data,e.width,e.height],s=new Uint8ClampedArray(r);return l(r,s,n,o,a),new ImageData(s,n,o)}}return null}function h(e,t){if(e.easyCompare&&e.easyCompare.originalImage){const t=e.easyCompare.originalImage;return t.ready&&(t.style.width=`${100*C}%`),t}{const{canvas:a,context:r}=i(),n=e=>{null!==e&&e>=0?(a.width=120,r.font="16px sans serif",r.fillStyle="rgba(255, 255, 255, 255)",r.fillText(`Loading ${(100*e).toFixed(1)}%`,0,15)):e<0&&(a.width=80,r.font="16px sans serif",r.fillStyle="rgba(255, 255, 255, 255)",r.fillText("Loading...",0,15))},o=(e,t,n)=>{f(e,t).then(t=>{n(t),a.src=e,a.width=t.width,a.height=t.height,r.putImageData(t,0,0),a.style.width=`${100*C}%`,a.ready=!0})};return a.width=80,a.height=20,r.font="16px sans serif",r.fillStyle="rgba(255, 255, 255, 255)",r.fillText("Loading...",0,15),a.ready=!1,a.targetImage=e,t.append(a.parentElement),e.easyCompare||(e.easyCompare={}),e.easyCompare.originalImage=a,e.easyCompare.originalImagePromise=(t=>new Promise(async a=>{let r,n,s=e.src;for(let r of v)if(s=s.replace(r[0],r[1]),s!==e.src)return void o(s,t,a);if(n=e.parentElement.href,r=n){for(let e of I)if(r=r.replace(e[0],e[1]),r!==n)break;r.match(/\.png$|\.jpe?g$|\.webp|\.gif|\.bmp|\.svg$/)?o(r,t,a):c(r).then(e=>{o(e||s,t,a)})}else o(s,t,a)})),e.easyCompare.originalImagePromise(n),a}}function p(e,t,a){if(e.src===t.src)return h(e);if(e.easyCompare&&e.easyCompare[t.src]){e.easyCompare[t.src].targetImage=e,e.easyCompare[t.src].baseImage=t;const a=e.easyCompare[t.src];return a.ready&&(a.style.width=`${100*C}%`),a}{const{canvas:r,context:n}=i();r.width=80,r.height=20,n.font="16px sans serif",n.fillStyle="rgba(255, 255, 255, 255)",n.fillText("Loading...",0,15),r.ready=!1,r.targetImage=e,r.baseImage=t,r.threshold=-1,r.step=.001,a.append(r.parentElement),e.easyCompare||(e.easyCompare={}),e.easyCompare[t.src]=r,t.easyCompare||(t.easyCompare={}),t.easyCompare[e.src]=r;let o=[0,0];const s=(e,t)=>{null!==e&&e>=0&&null!==t?(o[t]=e,r.width=120,n.font="16px sans serif",n.fillStyle="rgba(255, 255, 255, 255)",n.fillText(`Loading ${(50*(o[0]+o[1])).toFixed(1)}%`,0,15)):e<0?(r.width=80,n.font="16px sans serif",n.fillStyle="rgba(255, 255, 255, 255)",n.fillText("Loading...",0,15)):(r.width=80,n.font="16px sans serif",n.fillStyle="rgba(255, 255, 255, 255)",n.fillText("Diffing...",0,15))};return h(e,a),h(t,a),Promise.all([e.easyCompare.originalImagePromise(e=>s(e,0)),t.easyCompare.originalImagePromise(e=>s(e,1))]).then(e=>(s(null,null),d(...e,{alpha:.5,threshold:.007}))).then(e=>{null===e?(r.width=120,n.font="16px sans serif",n.fillStyle="rgba(255, 255, 255, 255)",n.fillText("Sizes Not Match",0,15)):(r.width=e.width,r.height=e.height,n.putImageData(e,0,0),r.threshold=.007,r.style.width=`${100*C}%`,r.ready=!0)}).catch(e=>{console.warn(e),r.width=120,n.font="16px sans serif",n.fillStyle="rgba(255, 255, 255, 255)",n.fillText("Sth. Went Wrong",0,15)}),r}}function m(e,t,a){if(e.easyCompare&&e.easyCompare[t]){const a=e.easyCompare[t];return a.ready&&(a.style.width=`${100*C}%`),a}{const{canvas:r,context:n}=i();r.width=80,r.height=20,n.font="16px sans serif",n.fillStyle="rgba(255, 255, 255, 255)",n.fillText("Loading...",0,15),r.ready=!1,r.targetImage=e,a.append(r.parentElement),e.easyCompare||(e.easyCompare={}),e.easyCompare[t]=r;const o=e=>{null!==e&&e>=0?(r.width=120,n.font="16px sans serif",n.fillStyle="rgba(255, 255, 255, 255)",n.fillText(`Loading ${(100*e).toFixed(1)}%`,0,15)):e<0?(r.width=80,n.font="16px sans serif",n.fillStyle="rgba(255, 255, 255, 255)",n.fillText("Loading...",0,15)):(r.width=80,n.font="16px sans serif",n.fillStyle="rgba(255, 255, 255, 255)",n.fillText("Filtering...",0,15))};return h(e,a),e.easyCompare.originalImagePromise(o).then(e=>(o(null),M[t](e))).then(e=>{r.width=e.width,r.height=e.height,n.putImageData(e,0,0),r.style.width=`${100*C}%`,r.ready=!0}),r}}function u(e){return e.find("canvas:visible")}function y(e){e.attr({fill:"#008000"}).css({cursor:"pointer",opacity:"1"})[0].state=!0}function w(t,a){const r=u(t).hide()[0];(r&&(a=r.targetImage)||a)&&a.easyCompare&&void 0!==a.easyCompare.boxShadow&&e(a).css("box-shadow",a.easyCompare.boxShadow)}function b(a,r,n){function o(){try{v=u(a)[0].targetImage}catch(e){v=void 0,e instanceof TypeError||console.warn(e)}}function s(e="easycompare.png"){try{const t=u(a)[0],r=t.src||t.toDataURL("image/png").replace(/^data:image\/[^;]/,"data:application/octet-stream");GM_download({url:r,name:e})}catch(e){e instanceof TypeError||console.warn(e)}}function i(t){M=M===t?"none":t;try{const t=u(a).hide()[0];let r;r=e("none"===M?h(t.targetImage,a):m(t.targetImage,M,a)),r.css("outline-color",t.style["outline-color"]).show()}catch(e){e instanceof TypeError||console.warn(e)}}function c(e){try{e&&C<1.95?C+=.1:!e&&C>.15&&(C-=.1);const t=u(a)[0];t.ready&&(t.style.width=`${100*C}%`),n.text(`Zoom: ${parseInt(100*C)}%`).css("opacity","1"),setTimeout(()=>{n.css("opacity","0")},P)}catch(e){e instanceof TypeError||console.warn(e)}}function l(){try{if(1!==C){C=1;const e=u(a)[0];e.ready&&(e.style.width=`${100*C}%`),n.text("Zoom: 100%").css("opacity","1"),setTimeout(()=>{n.css("opacity","0")},P)}}catch(e){e instanceof TypeError||console.warn(e)}}function f(e){try{const t=u(a)[0];let r=t.threshold;if(void 0!==r&&r>=0){const a=r;n.text(`Threshold: ${a.toFixed(4)}`).css("opacity","1"),e?(r+=t.step,r>1&&(r=1)):(r-=t.step,r<0&&(r=0)),t.threshold=-1;const[o,s]=[t.baseImage.easyCompare.originalImage,t.targetImage.easyCompare.originalImage];d(o.getContext("2d").getImageData(0,0,o.width,o.height),s.getContext("2d").getImageData(0,0,s.width,s.height),{alpha:.5,threshold:r}).then(e=>{t.getContext("2d").putImageData(e,0,0),n.text(`Threshold: ${r.toFixed(4)}`).css("opacity","1"),setTimeout(()=>{t.threshold=r,n.css("opacity","0")},P)})}}catch(e){e instanceof TypeError||console.warn(e)}}function g(e){try{const t=u(a)[0];let r=t.step;r&&(t.step=e&&r<=.1?10*r:e?1:!e&&r>=.001?r/10:1e-4,n.text(`Step: ${t.step.toFixed(4)}`).css("opacity","1"),setTimeout(()=>n.css("opacity","0"),P))}catch(e){e instanceof TypeError||console.warn(e)}}function y(){try{w(a,u(a)[0].targetImage)}catch(e){e instanceof TypeError||console.warn(e)}a.find("canvas").toArray().forEach(e=>{const t=e.targetImage;delete t.easyCompare,e.parentElement.remove()})}function b(t,n){try{const o=u(a)[0].targetImage,s=r.index(o);w(a,o);const i=r[t?s-T:s+T]||r[s];e(i).trigger("mouseenter",[n])}catch(e){e instanceof TypeError||console.warn(e)}}t&&t.pause(),a.show()[0].state=!0;let v,I=["red","blue"],T=1,M="none",P=300;r.on("mouseenter.compare",(t,r)=>{const n=t.currentTarget;let o;if(clearTimeout(k),w(a),n.easyCompare||(n.easyCompare={},n.easyCompare.boxShadow=n.style["box-shadow"]),e(n).css({"box-shadow":"0px 0px 8px "+I[0]}),(t.shiftKey||r)&&v)o=e(p(n,v,a)).css("outline-color",I[0]).show();else switch(M){case"none":o=e(h(n,a)).css("outline-color",I[0]).show();break;default:o=e(m(n,M,a)).css("outline-color",I[0]).show()}I.push(I.shift())}).on("mouseleave.compare",e=>{const t=e.currentTarget;k=setTimeout(()=>{w(a,t)},200)}),e(document).on("scroll.compare",t=>{const n=u(a)[0];if(n){const t=e(n.targetImage);t.is(":hover")||(w(a,t[0]),r.find("img:hover").trigger("mousenter"))}}).on("keydown.compare",e=>{switch(e.preventDefault(),e.stopImmediatePropagation(),e.key){case"Escape":x(a,r);break;case"Shift":o();break;case"+":case"=":e.ctrlKey&&c(!0);break;case"-":case"_":e.ctrlKey&&c(!1);break;case"O":case"o":e.ctrlKey&&l();break;case"S":case"s":e.ctrlKey?s():i("solar");break;case"A":case"a":i("s2lar");break;case"I":case"i":case"ArrowUp":f(!0);break;case"K":case"k":case"ArrowDown":f(!1);break;case"J":case"j":case"ArrowLeft":g(!0);break;case"L":case"l":case"ArrowRight":e.ctrlKey?y():g(!1);break;case"Q":case"q":a.css("opacity",.5);break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":T=parseInt(e.key);break;case"0":T=10;break;case"W":case"w":b(!0,e.shiftKey);break;case"E":case"e":b(!1,e.shiftKey)}return!1}).on("keyup.compare",e=>{switch(e.preventDefault(),e.stopImmediatePropagation(),e.key){case"Q":case"q":a.css("opacity","")}return!1})}function x(a,r){t&&t.unpause(),w(a),a.hide()[0].state=!1,r.off("mouseenter.compare").off("mouseleave.compare"),e(document).off("scroll.compare").off("keydown.compare")}if(t){let e=t.prototype||t;const a=e.stopCallback;e.stopCallback=function(e,t,r){var n=this;return!!n.paused||a.call(n,e,t,r)},e.pause=function(){var e=this;e.paused=!0},e.unpause=function(){var e=this;e.paused=!1}}let k,C=1;const v=[[/\.thumb\.jpe?g$/,""],[/\.md\.png$/,".png"],[/\.th\.png$/,".png"],[/_thumb\.png$/,".png"],[/img\.awesome\-hd\.me\/t(\/\d+)?\//,"img.awesome-hd.me/images/"],[/thumbs((?:\d+)?\.imgbox\.com\/.+_)t\.png$/,"images$1o.png"],[/t((?:\d+)?\.pixhost\.to\/)thumbs\//,"img$1images/"],[/t(\.hdbits\.org\/.+)\.jpg$/,"i$1.png"],[/^.*?imagecache\.php\?url=(https?)%3A%2F%2Fthumbs(\d+)?\.imgbox\.com%2F(\w+)%2F(\w+)%2F(\w+)_t\.png/,"$1://images$2.imgbox.com/$3/$4/$5_o.png"]],I=[[/^https?:\/\/anonym\.to\/\?(.*)$/,(e,t)=>decodeURIComponent(t)],[/^https?:\/\/www\.dereferer\.org\/\?(.*)$/,(e,t)=>decodeURIComponent(t)],[/^(?:https?:\/\/pterclub\.com)?\/link\.php\?sign=.+?&target=(.*)$/,(e,t)=>decodeURIComponent(t.replace(/\+/g," ")).replace(/ /g,"%20")],[/^.*?imagecache\.php\?url=(.*)$/,(e,t)=>decodeURIComponent(t.replace(/\+/g," ")).replace(/ /g,"%20")]],T=["#image-viewer-container>img",".image-container img","div.img.big>img","img.mainimage","img#img"],M={solar:e=>g(e,$||j),s2lar:e=>g(e,A||S)};let P,$,A,U,j=GM_getValue("solarCurve"),S=GM_getValue("s2larCurve");j?(j=JSON.parse(j),S=JSON.parse(S)):(j=[Array.from({length:256},(e,t)=>n(t)),Array.from({length:256},(e,t)=>n(t-5)),Array.from({length:256},(e,t)=>n(t+5))],GM_setValue("solarCurve",JSON.stringify(j)),S=[Array.from({length:256},(e,t)=>j[0][[j[0][t]]]),Array.from({length:256},(e,t)=>j[1][[j[1][t]]]),Array.from({length:256},(e,t)=>j[2][[j[2][t]]])],GM_setValue("s2larCurve",JSON.stringify(S))),j=j.map(e=>new Uint8Array(e)),S=S.map(e=>new Uint8Array(e));const E='const defaultOptions={threshold:.1,includeAA:!1,alpha:.1,aaColor:[255,255,0],diffColor:[255,0,0],diffMask:!1};function pixelmatch(a,b,c,d,e,f){if(!isPixelData(a)||!isPixelData(b)||c&&!isPixelData(c))throw new Error("Image data: Uint8Array, Uint8ClampedArray or Buffer expected.");if(a.length!==b.length||c&&c.length!==a.length)throw new Error("Image sizes do not match.");if(a.length!==4*(d*e))throw new Error("Image data size does not match width/height.");f=Object.assign({},defaultOptions,f);const g=d*e,h=new Uint32Array(a.buffer,a.byteOffset,g),j=new Uint32Array(b.buffer,b.byteOffset,g);let k=!0;for(let l=0;l<g;l++)if(h[l]!==j[l]){k=!1;break}if(k){if(c&&!f.diffMask)for(let b=0;b<g;b++)drawGrayPixel(a,4*b,f.alpha,c);return 0}const l=35215*f.threshold*f.threshold;let m=0;const[n,o,p]=f.aaColor,[q,r,s]=f.diffColor;for(let g=0;g<e;g++)for(let h=0;h<d;h++){const i=4*(g*d+h),j=colorDelta(a,b,i,i);j>l?!f.includeAA&&(antialiased(a,h,g,d,e,b)||antialiased(b,h,g,d,e,a))?c&&!f.diffMask&&drawPixel(c,i,n,o,p):(c&&drawPixel(c,i,q,r,s),m++):c&&!f.diffMask&&drawGrayPixel(a,i,f.alpha,c)}return m}function isPixelData(a){return ArrayBuffer.isView(a)&&1===a.constructor.BYTES_PER_ELEMENT}function antialiased(a,b,c,d,e,f){const g=Math.max(b-1,0),h=Math.max(c-1,0),i=Math.min(b+1,d-1),j=Math.min(c+1,e-1);let k,l,m,n,o=b===g||b===i||c===h||c===j?1:0,p=0,q=0;for(let r=g;r<=i;r++)for(let e=h;e<=j;e++){if(r===b&&e===c)continue;const f=colorDelta(a,a,4*(c*d+b),4*(e*d+r),!0);if(0!==f)f<p?(p=f,k=r,l=e):f>q&&(q=f,m=r,n=e);else if(o++,2<o)return!1}return 0!==p&&0!==q&&(hasManySiblings(a,k,l,d,e)&&hasManySiblings(f,k,l,d,e)||hasManySiblings(a,m,n,d,e)&&hasManySiblings(f,m,n,d,e))}function hasManySiblings(a,b,c,d,e){const f=Math.max(b-1,0),g=Math.max(c-1,0),h=Math.min(b+1,d-1),i=Math.min(c+1,e-1),j=4*(c*d+b);let k=b===f||b===h||c===g||c===i?1:0;for(let l=f;l<=h;l++)for(let e=g;e<=i;e++){if(l===b&&e===c)continue;const f=4*(e*d+l);if(a[j]===a[f]&&a[j+1]===a[f+1]&&a[j+2]===a[f+2]&&a[j+3]===a[f+3]&&k++,2<k)return!0}return!1}function colorDelta(a,b,c,d,e){let f=a[c+0],g=a[c+1],h=a[c+2],j=a[c+3],k=b[d+0],l=b[d+1],m=b[d+2],n=b[d+3];if(j===n&&f===k&&g===l&&h===m)return 0;255>j&&(j/=255,f=blend(f,j),g=blend(g,j),h=blend(h,j)),255>n&&(n/=255,k=blend(k,n),l=blend(l,n),m=blend(m,n));const o=rgb2y(f,g,h)-rgb2y(k,l,m);if(e)return o;const p=rgb2i(f,g,h)-rgb2i(k,l,m),i=rgb2q(f,g,h)-rgb2q(k,l,m);return .5053*o*o+.299*p*p+.1957*i*i}function rgb2y(a,c,d){return .29889531*a+.58662247*c+.11448223*d}function rgb2i(a,c,d){return .59597799*a-.2741761*c-.32180189*d}function rgb2q(a,c,d){return .21147017*a-.52261711*c+.31114694*d}function blend(b,c){return 255+(b-255)*c}function drawPixel(a,c,d,e,f){a[c+0]=d,a[c+1]=e,a[c+2]=f,a[c+3]=255}function drawGrayPixel(a,c,d,e){const f=a[c+0],h=a[c+1],g=a[c+2],b=blend(rgb2y(f,h,g),d*a[c+3]/255);drawPixel(e,c,b,b,b)}self.onmessage=a=>{img1=new Uint8ClampedArray(a.data.img1),img2=new Uint8ClampedArray(a.data.img2),diff=new Uint8ClampedArray(img1),width=a.data.width,height=a.data.height,init=a.data.init,key=a.data.key;try{pixelmatch(img1,img2,diff,width,height,init),self.postMessage({diff:diff.buffer,width:width,height:height,key:key},[diff.buffer])}catch(a){console.warn(a),self.postMessage({diff:null,key:key})}};',D="let R,G,B;self.onmessage=(e=>{const a=e.data.key;if(e.data.R&&e.data.G&&e.data.B)R=new Uint8ClampedArray(e.data.R),G=new Uint8ClampedArray(e.data.G),B=new Uint8ClampedArray(e.data.B),self.postMessage({result:!0});else{const t=new Uint8ClampedArray(e.data.img),l=new Uint8ClampedArray(t),s=e.data.width,r=e.data.height;try{for(let e=0;e<r;++e)for(let a=0;a<s;++a){let r=4*a+e*s*4;l[r]=R[t[r]],l[r+1]=G[t[r+1]],l[r+2]=B[t[r+2]],l[r+3]=t[r+3]}self.postMessage({filter:l.buffer,width:s,height:r,key:a},[l.buffer])}catch(e){console.warn(e),self.postMessage({filter:null,key:a})}}});";try{const e=new Blob([E],{type:"application/javascript"});P=new Worker(r.createObjectURL(e)),P.keyPool={},r.revokeObjectURL(e);const t=new Blob([D],{type:"application/javascript"}),a=r.createObjectURL(t);$=new Worker(a),$.keyPool={};const n=o($,j);A=new Worker(a),A.keyPool={};const s=o(A,S);r.revokeObjectURL(a),U=Promise.all([n,s])}catch(e){try{const e=`data:application/javascript,${encodeURIComponent(E)}`;P=new Worker(e),P.keyPool={};const t=`data:application/javascript,${encodeURIComponent(D)}`;$=new Worker(t),$.keyPool={};const a=o($,j);A=new Worker(t),A.keyPool={};const r=o(A,S);U=Promise.all([a,r])}catch(e){P=null,$=null}}const R=e("<div>").css({top:"50%",left:"50%","z-index":2147483647,position:"fixed",transform:"translate(-50%, -50%)",opacity:"0","vertical-align":"middle","pointer-events":"none",transition:"all 0.1s","font-size":"500%",color:"yellow","font-weight":"bold"}),L=e("<div/>").css({id:"easy-compare-overlay",position:"fixed",top:0,right:0,bottom:0,left:0,"z-index":2147483646,"background-color":"rgba(0, 0, 0, 0.75)","pointer-events":"none",display:"none"}).append(R),G=e('<svg xmlns="http://www.w3.org/2000/svg">\n<path id="ld" d="M20 6H10c-2.21 0-4 1.79-4 4v28c0 2.21 1.79 4 4 4h10v4h4V2h-4v4zm0 30H10l10-12v12zM38 6H28v4h10v26L28 24v18h10c2.21 0 4-1.79 4-4V10c0-2.21-1.79-4-4-4z"/>\n</svg>').attr({width:"30",height:"30",viewBox:"0 0 48 48",stroke:"white","stroke-width":"5px",fill:"gray"}).css({position:"fixed",top:"15px",right:"15px","z-index":2147483647,"paint-order":"stroke",opacity:0,transition:"all 0.2s",cursor:"auto"}).on("mouseenter",t=>{e(t.currentTarget).attr({fill:"gray"}).css({opacity:.2}),k=setTimeout(()=>y(e(t.currentTarget)),L[0].state?0:1e3)}).on("mouseleave",t=>{clearTimeout(k),e(t.currentTarget).attr({fill:"gray"}).css({cursor:"auto",opacity:0})[0].state=!1}).click(t=>{if(t.currentTarget.state)switch(L[0].state){case!1:b(L,e(':not("#easy-compare-overlay") img:visible'),R);break;case!0:x(L,e(':not("#easy-compare-overlay") img:visible'))}else{let e=t.clientX,a=t.clientY;const r=document.elementsFromPoint(e,a).find(e=>!["svg","path"].includes(e.tagName));r.click()}}).mousedown(t=>{t.currentTarget.state&&e(t.currentTarget).attr({fill:"#006000"})}).mouseup(t=>{t.currentTarget.state&&e(t.currentTarget).attr({fill:"#008000"})});L[0].state=!1,G[0].state=!1,e("body").append(G).append(L)})(window.$.noConflict(!0),unsafeWindow.Mousetrap,window.pixelmatch,unsafeWindow.URL.createObjectURL?unsafeWindow.URL:unsafeWindow.webkitURL);